<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>eyesmedia covid19 - 防疫新生活</title>
<link rel="stylesheet" href="./css/reset.css">
<link rel="stylesheet" href="./css/main.css">
<script type="text/javascript" src="./js/jquery.js"></script>
<script type="text/javascript" src="./js/common.js"></script>
<script src="https://static.line-scdn.net/liff/edge/versions/2.8.0/sdk.js"></script>

</head>
<body>
  <div class="app">
    <div class="main store">
      <div class="endpointType-block endpointType_STANDARD">
        <div class="main-banner">店家申請單 | 一般類</div>
      </div>
      <div class="endpointType-block endpointType_TRAFFIC">
        <div class="main-banner">店家申請單 | 交通類</div>
      </div>
      <div class="endpointType-block endpointType_QRCODE">
        <div class="main-banner">店家專屬QRcode</div>
      </div>

      <div class="main-content">
        <!-- 一般類/交通類 共用 -->
        <div class="endpointType-block endpointType_STANDARD endpointType_TRAFFIC">
          <h4 class="text-center">首次使用需要先填寫資料，一個Line帳號只能申請一次。</h4>
        </div>

        <!-- 一般類介面 -->
        <div class="endpointType-block endpointType_STANDARD">
          <div id="normalForm">
            <label class="label-box">
              <h5>招牌名稱<span class="require">*</span></h5>
              <input type="text" placeholder="請輸入" require>
            </label>
            <label class="label-box">
              <h5>登記公司/店家名稱</h5>
              <input type="text" placeholder="請輸入">
            </label>
            <label class="label-box">
              <h5>統一編號</h5>
              <input type="tel" placeholder="請輸入">
            </label>
            <label class="label-box">
              <h5>營業地址<span class="require">*</span></h5>
              <input type="text" placeholder="請輸入" require>
            </label>
            <label class="label-box">
              <h5>聯絡人姓名<span class="require">*</span></h5>
              <input type="text" placeholder="請輸入" require>
            </label>
            <label class="label-box">
              <h5>聯絡電話<span class="require">*</span></h5>
              <input type="tel" placeholder="例:0912345678" require>
            </label>

            <button type="button" id="normal-send-btn" disabled>送出申請</button>
          </div>
        </div>

        <!-- 交通類介面 -->
        <div class="endpointType-block endpointType_TRAFFIC">
          <div id="trafficForm">
            <label class="label-box">
              <h5>公車/客運路線<span class="require">*</span></h5>
              <input type="text" placeholder="例:000" require>
            </label>
            <label class="label-box">
              <h5>公車/客運車號<span class="require">*</span></h5>
              <input type="text" placeholder="例:123-AB" require>
            </label>
            <label class="label-box">
              <h5>登記公司名稱</h5>
              <input type="text" placeholder="請輸入">
            </label>
            <label class="label-box">
              <h5>統一編號</h5>
              <input type="text" placeholder="請輸入">
            </label>
            <label class="label-box">
              <h5>營業地址<span class="require">*</span></h5>
              <input type="text" placeholder="請輸入" require>
            </label>
            <label class="label-box">
              <h5>聯絡人姓名<span class="require">*</span></h5>
              <input type="text" placeholder="請輸入" require>
            </label>
            <label class="label-box">
              <h5>聯絡電話<span class="require">*</span></h5>
              <input type="text" placeholder="例:0912345678" require>
            </label>

            <button type="button" id="traffic-send-btn" disabled>送出申請</button>
          </div>
        </div>

        <!-- B端28日足跡 -->
        <div class="endpointType-block endpointType_B_FOOTPRINT">
          <h3>28日足跡查詢</h3>
          <div class="introduction-box">依照「COVID-19(武漢肺炎)」防疫新生活運動：實聯制措施指引，基於個資法保護，僅顯示最近20筆資料，其餘資料封存於伺服器，最多存放28天就會主動進行刪除。</div>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>填寫時間</th>
                <th>地點</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="note-box">
            備註：
            <ul>
              <li>1. 為維持國內疫情之穩定控制，艾斯移動股份有限公司 配合政府「COVID19（武漢肺炎）」 防疫新生活運動，採行實聯制措施。依據「個人資料保護法之特定目的 及個人資料之類別」代號 012 公共衛生或傳染病防治之特定目的，蒐集 以上個人資料，且不得為目的外利用。所蒐集之資料僅保存 28 日，屆 期銷毀。感謝您的配合。</li>
              <li>2. 個人資料利用之對象及方式：為防堵疫情而有必要時，得提供衛生主管 機關依傳染病防治法等規定進行疫情調查及聯繫使用。</li>
              <li>3. 當事人就其個人資料得依個人資料保護法規定，向 艾斯移動股份有限公司（資料蒐 集機關）行使權利，包括查詢或請求閱覽、請求製給複製本、請求補充 或更正、請求停止處理或利用、請求刪除等。相關權利行使方式：以電子郵件(E-mail)寄送至：mobiics@mobii.ai</li>
              <li>4. 當事人如無法配合本實聯制作業，將○○○○○（請說明對其權益之影 響，如無法進入場館或參與活動等）。</li>
              <li>5. 本實聯制其他相關措施說明，請參閱 http://at.cdc.tw/8QI4hA。</li>
            </ul>
          </div>
        </div>

        <!-- 下載QA code -->
        <div class="endpointType-block endpointType_QRCODE">
          <h4>
            已完成申請，請自行下載 QRcode，可直接截圖或列印。
            user (顧客/訪客/乘客)掃描QRcode，完成實聯制登記。
          </h4>

          <img id="qrcodeImg" src="https://cdn.eyesmedia.com.tw/sit/images/convid19qrcode/7b8e733f-c8dc-4d33-a863-ccd9cd79db59123">
          
          <a class="download-link" href="https://cdn.eyesmedia.com.tw/sit/images/convid19qrcode/7b8e733f-c8dc-4d33-a863-ccd9cd79db59123" download>下載QRcode</a>

        </div>

        <br><br>

        <div id="userProfileBox"></div>
  
      </div>
    </div>

  </div>

<script>
$(function() {
  $('#userProfileBox').append(`<div>window.location.href: ${JSON.stringify(window.location.href)}<br><br></div>`);

  var storeModel = {};  // 記住店家在資料庫中資料用

  var endpointType = null; // 記住當前是哪一個 endpointType 用
  var storeId = null; // 記住當前的店家id
  var liffId = null;  // 記住當前的 liffid

  // 取得 liff 使用者基本資料
  function getUserProfile(accessToken) {
    //透過 token 取得使用者資訊
    fetch('https://api.line.me/v2/profile', {
      method: 'GET',
      headers: {
        'content-type': 'application/json',
        'Authorization': `Bearer ${accessToken}`
      },
    }).then(response => {
      return response.json();
    }).then((data) => {

      // TODO... 開發測試用
      $('#userProfileBox').append(`<div>https://api.line.me/v2/profile:'${JSON.stringify(data)}'<br><br></div>`);
      $('#userProfileBox').append(
        'userId:' + data.userId + '<br>' +
        'displayName:' + data.displayName + '<br>' +
        'pictureUrl:' + data.pictureUrl + '<br>'
      );

    });
  }
  
  // liff 初始化
  function onload() {
    var urlParm = parseURLparm();
    storeId = urlParm.storeId;
    liffId = urlParm.liffId;
    endpointType = urlParm.endpointType;
    $('#userProfileBox').append(`<div><br>storeId: ${storeId}</div>`);
    $('#userProfileBox').append(`<div>liffId: ${liffId}</div>`);
    $('#userProfileBox').append(`<div>endpointType: ${endpointType}<br><br></div>`);

    showEndpointTypeBlock (endpointType);


    if (liff) {
      // TODO... 由於 app 中 liff 打開之後後面的url參數會被轉碼... 這部分還要研究所以先寫死 1633210473-BZ1zNNWk
      liff.init({ liffId: '1633210473-BZ1zNNWk' }).then(() => {
        var accessToken = liff.getAccessToken();
        $('#userProfileBox').append(`<div>accessToken: ${accessToken}<br><br></div>`);
        getUserProfile(accessToken);
      }).catch((error) => {
        alert('liff init error: ' + JSON.stringify(error));
      });
    }
  }

  // event 一般類的表單欄位檢查是有值用
  $('#normalForm').find('input[require]').change((event) => {
    var isFull = true;
    $.each($('#normalForm').find('input[require]'), function(i, item) {
      if (!$(item).val()) {
        isFull = false;
      }
    });
    if (isFull) {
      $('#normal-send-btn').removeAttr('disabled');
    } else {
      $('#normal-send-btn').attr('disabled', true);
    }
  });

  // event 交通類的表單欄位檢查是有值用
  $('#trafficForm').find('input[require]').change((event) => {
    var isFull = true;
    $.each($('#trafficForm').find('input[require]'), function(i, item) {
      if (!$(item).val()) {
        isFull = false;
      }
    });
    if (isFull) {
      $('#traffic-send-btn').removeAttr('disabled');
    } else {
      $('#traffic-send-btn').attr('disabled', true);
    }
  });


  // event click 一般類的送出按鈕
  $('#normal-send-btn').click(() => {
    console.log('一般類的送出按鈕');
  });

  // event click 交通類的送出按鈕
  $('#traffic-send-btn').click(() => {
    console.log('交通類的送出按鈕');
  });


  // TODO... 測試28日足跡查詢用
  var trHTML = '';
  for (var i = 0; i <= 10; i++) {
    trHTML += '<tr>';
    trHTML += '  <td>'+ (i+1) +'</td>';
    trHTML += '  <td>2021/05/17 11:56</td>';
    trHTML += '  <td>XXX大樓</td>';
    trHTML += '  <td>36.3</td>';
    trHTML += '</tr>';
  }
  $('table tbody').append(trHTML);


  onload();
});
</script>
</body>
</html>