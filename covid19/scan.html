<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>test covid19</title>
<link rel="stylesheet" href="./css/reset.css">
<link rel="stylesheet" href="./css/main.css">
<script type="text/javascript" src="./js/jquery.js"></script>
<script type="text/javascript" src="https://static.line-scdn.net/liff/edge/versions/2.3.0/sdk.js"></script>

</head>
<body onload="onload()">

  <div class="app">
    <div class="main scan">
      <div class="main-content">
        
        <div class="scan-btn-box">
          <button type="button">點擊掃描</button>
          <input type="file" accept="image/*" capture="camera" id="scanQRcodeInput">
        </div>

        <div id="userProfileBox"></div>
  
      </div>
    </div>
  </div>

<script>
  function onload() {
    
    if (liff) {
      // TODO... 這個 liffId 之後要請ＰＭ提供
      liff.init({ liffId: '1633210473-BZ1zNNWk' }).then(() => {
        var accessToken = liff.getAccessToken();

        var test = '';
        test +=
          'getLanguage: ' + liff.getLanguage() + '<br>' +
          'getVersion: ' + liff.getVersion() + '<br>' +
          'isInClient: ' + liff.isInClient() + '<br>' +
          'isLoggedIn: ' + liff.isLoggedIn() + '<br>' +
          'getOS: ' + liff.getOS() + '<br>' +
          'getAccessToken: ' + accessToken + '<br>';

        //透過 token 取得使用者資訊
        fetch('https://api.line.me/v2/profile', {
          method: 'GET',
          headers: {
            'content-type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
        }).then(response => {
          return response.json();
        }).then((data) => {
          $('#userProfileBox').append(
            'userId:' + data.userId + '<br>' +
            'displayName:' + data.displayName + '<br>' +
            'pictureUrl:' + data.pictureUrl + '<br>'
          );

          // 點擊掃描按鈕
          var $scanQRcodeInput = $('#scanQRcodeInput');
          $('#scanQRcodeInput').change(function() {

            //圖片畫質壓縮比率，size單位為MB
            var getCompressRate = function (allowMaxSize, fileSize) {
              var compressRate = 1;
              if (fileSize / allowMaxSize > 4) {
                compressRate = 0.5;
              } else if (fileSize / allowMaxSize > 3) {
                compressRate = 0.6;
              } else if (fileSize / allowMaxSize > 2) {
                compressRate = 0.7;
              } else if (fileSize > allowMaxSize) {
                compressRate = 0.8;
              } else {
                compressRate = 0.9;
              }
              return compressRate;
            };

            //建立base64的圖片資料, res代表上傳的base64圖片資料，fileSize圖片的k數
            var createBase64URL = function (res, fileSize) { 
              var img = new Image(),
                  maxW = 480; //設定最大寬度
              img.onload = function () {
                //建立 canvas 物件
                var cvs = document.createElement('canvas'),
                    ctx = cvs.getContext('2d');
                //限制圖片大小
                if (img.width > maxW) {
                  img.height *= maxW / img.width;
                  img.width = maxW;
                }
                cvs.width = img.width;
                cvs.height = img.height;
                ctx.clearRect(0, 0, cvs.width, cvs.height);
                ctx.drawImage(img, 0, 0, img.width, img.height);
                var compressRate = getCompressRate(1, fileSize);
                console.log('畫質壓縮比', compressRate);
                //document.body.appendChild(cvs); //開發期間可以在body將canvas印出來看看
                var base64URL = cvs.toDataURL('image/jpeg', compressRate);
                $('#userProfileBox').append('<div>' + base64URL + '</div>');
                //send(base64URL); //ajax
              }
              img.src = res;
            };

            //建立讀取檔案物件
            var reader = new FileReader();
            reader.onload = function (e) {
              var fileSize = Math.round($scanQRcodeInput[0].files[0]/1024/1024) ; //以MB為單位
              createBase64URL(e.target.result, fileSize);
            };
            reader.readAsDataURL($scanQRcodeInput[0].files[0]);

          });
          
        });

      }).catch((error) => {
        alert('liff init error: ' + JSON.stringify(error));
      });
    }

  }
</script>
</body>
</html>