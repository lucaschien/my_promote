<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>eyesmedia covid19 - 防疫新生活</title>
<link rel="stylesheet" href="./css/reset.css">
<link rel="stylesheet" href="./css/main.css">
<script type="text/javascript" src="./js/jquery.js"></script>
<script type="text/javascript" src="./js/common.js"></script>
<!-- <script type="text/javascript" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script> -->
<!-- <script type="text/javascript" src="https://static.line-scdn.net/liff/edge/versions/2.10.0/sdk.js"></script> -->

<script src="https://static.line-scdn.net/liff/edge/versions/2.8.0/sdk.js"></script>

</head>
<body>

  <div class="app">
    <div class="main">
      <!-- 已申請通行證,未申請通行證 -->
      <div class="endpointType-block endpointType_REISTER">
        <div class="main-banner">
          防疫新生活｜
          <span class="show" id="notLogin-banner-word">實聯制</span>
          <span id="logged-banner-word">現場登記</span>
        </div>
      </div>
      <div class="main-content">

        <!-- 已申請通行證,未申請通行證 -->
        <div class="endpointType-block endpointType_REISTER">
          <!-- 未登入介面 -->
          <div id="notLogin">
            <label class="label-box">
              <h5>姓名<span class="require">*</span></h5>
              <input type="text" placeholder="請輸入" require>
            </label>
            <label class="label-box">
              <h5>手機號碼<span class="require">*</span></h5>
              <input type="tel" placeholder="例:0912345678" require>
            </label>
            <label class="label-box">
              <h5>備註<span class="require">*</span></h5>
              <input type="text" placeholder="例如:額溫" require>
            </label>

            <label>
              <input type="checkbox" class="check-agree">我已閱讀並同意提供<a class="lookAuthorization" href="javascript:;">個資授權</a>
            </label>

            <button type="button" id="notLogin-send-btn" disabled>送出</button>
          </div>

          <!-- 已登入介面 -->
          <div id="logged">
            <h3>某某某店家</h3>
            <h4>防疫新生活，輕鬆掃QRcode，一秒完成實聯登記</h4>
            <label class="label-box">
              <h5>時間<span class="require">*</span></h5>
              <span class="display-value">2021/05/17 15:46</span>
            </label>
            <label class="label-box">
              <h5>姓名<span class="require">*</span></h5>
              <span class="display-value">王小明</span>
            </label>
            <label class="label-box">
              <h5>手機號碼<span class="require">*</span></h5>
              <span class="display-value">0915555555</span>
            </label>
            <label class="label-box">
              <h5>備註<span class="require">*</span></h5>
              <input type="text" placeholder="例如:額溫" require>
            </label>

            <label>
              <input type="checkbox" class="check-agree">我已閱讀並同意提供<a class="lookAuthorization" href="javascript:;">個資授權</a>
            </label>

            <button type="button" id="logged-send-btn" disabled>送出</button>

          </div>
        </div>        

         <!-- 28日足跡查詢 -->
        <div class="endpointType-block endpointType_FOOTPRINT">
          <h3>28日足跡查詢</h3>
          <div class="introduction-box">依照「COVID-19(武漢肺炎)」防疫新生活運動：實聯制措施指引，基於個資法保護，僅顯示最近20筆資料，其餘資料封存於伺服器，最多存放28天就會主動進行刪除。</div>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>填寫時間</th>
                <th>地點</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="note-box">
            備註：
            <ul>
              <li>1. 為維持國內疫情之穩定控制，艾斯移動股份有限公司 配合政府「COVID19（武漢肺炎）」 防疫新生活運動，採行實聯制措施。依據「個人資料保護法之特定目的 及個人資料之類別」代號 012 公共衛生或傳染病防治之特定目的，蒐集 以上個人資料，且不得為目的外利用。所蒐集之資料僅保存 28 日，屆 期銷毀。感謝您的配合。</li>
              <li>2. 個人資料利用之對象及方式：為防堵疫情而有必要時，得提供衛生主管 機關依傳染病防治法等規定進行疫情調查及聯繫使用。</li>
              <li>3. 當事人就其個人資料得依個人資料保護法規定，向 艾斯移動股份有限公司（資料蒐 集機關）行使權利，包括查詢或請求閱覽、請求製給複製本、請求補充 或更正、請求停止處理或利用、請求刪除等。相關權利行使方式：以電子郵件(E-mail)寄送至：mobiics@mobii.ai</li>
              <li>4. 當事人如無法配合本實聯制作業，將○○○○○（請說明對其權益之影 響，如無法進入場館或參與活動等）。</li>
              <li>5. 本實聯制其他相關措施說明，請參閱 http://at.cdc.tw/8QI4hA。</li>
            </ul>
          </div>
        </div>

        <br><br><br>
        <div class="endpointType-block endpointType_REISTER">
          <button id="testNo">開發測試用: 未登入</button>
          <button id="testYes">開發測試用: 已登入</button>
        </div>

        <div id="userProfileBox"></div>
  
      </div>
    </div>
    
    <!-- 授權說明 dialog -->
    <div class="dialog-box authorization">
      <div class="dialog-mask"></div>
      <div class="dialog-content">
        <h5>個資授權</h5>
        <div class="content-body">
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
          XXXXXXXX XXXXX XXXXXXXX XXXXXXX XXXXXXXX XXXXX XXXXXXXXXXXXXXX XXXXX XXXXXXXX XXXXXXX
        </div>
        <button id="understanding">我瞭解了</button>
      </div>
    </div>

    <!-- 已完成實聯登記 dialog -->
    <div class="dialog-box complete">
      <div class="dialog-mask"></div>
      <div class="dialog-content">
        <div class="content-body">您已完成本次實聯登記,感謝您的配合</div>
        <button id="closeLiff-btn">關閉</button>
        <!-- <button class="width-half" id="editUaerData-btn">修改登記資料</button> -->
      </div>
    </div>

  </div>

<script>
$(function() {
  var testHref = 'https://lucaschien.github.io/my_promote/covid19/index.html?liff.state=%3FstoreId%3Daaaa%26liffId%3D1633210473-BZ1zNNWk';
  $('#userProfileBox').append(`<div>window.location.href: ${JSON.stringify(window.location.href)}<br><br></div>`);

  var isLogded = false; // 記住是否已登入用
  var userModel = {};   // 記住使用者在資料庫中資料用
  var storeModel = {};  // 記住店家在資料庫中資料用

  var endpointType = null; // 記住當前是哪一個 endpointType 用
  var storeId = null; // 記住當前的店家id
  var liffId = null;  // 記住當前的 liffid

  

  // 解析瀏覽器url參數
  function parseURLparm() {
    var href = window.location.href;
    var vars = {}, hash;
    var hashes = href.slice(href.indexOf('?') + 1).split('&');
    for (var i = 0; i < hashes.length; i++) {
      hash = hashes[i].split('=');
      if (Array.isArray(hash[0], vars) > -1) {
        vars[hash[0]] = hash[1];
      }
    }
    return vars;
  }

  // 取得 liff 使用者基本資料
  function getUserProfile(accessToken) {
    //透過 token 取得使用者資訊
    fetch('https://api.line.me/v2/profile', {
      method: 'GET',
      headers: {
        'content-type': 'application/json',
        'Authorization': `Bearer ${accessToken}`
      },
    }).then(response => {
      return response.json();
    }).then((data) => {
      // TODO... 呼叫取得使用者是否已登入api
      isLogded = false;
      $('.recording').removeClass('logged');
      $('.recording').addClass('notLogin');


      // TODO... 開發測試用
      $('#userProfileBox').append(`<div>https://api.line.me/v2/profile:'${JSON.stringify(data)}'<br><br></div>`);
      $('#userProfileBox').append(
        'userId:' + data.userId + '<br>' +
        'displayName:' + data.displayName + '<br>' +
        'pictureUrl:' + data.pictureUrl + '<br>'
      );

    });
  }
  
  // liff 初始化
  function onload() {
    var urlParm = parseURLparm();
    storeId = urlParm.storeId;
    liffId = urlParm.liffId;
    endpointType = urlParm.endpointType;
    $('#userProfileBox').append(`<div><br>endpointType: ${endpointType}</div>`);
    $('#userProfileBox').append(`<div><br>storeId: ${storeId}</div>`);
    $('#userProfileBox').append(`<div>liffId: ${liffId}<br><br></div>`);

    showEndpointTypeBlock(endpointType);

    if (liff) {
      // TODO... 由於 app 中 liff 打開之後後面的url參數會被轉碼... 這部分還要研究所以先寫死 1633210473-BZ1zNNWk
      liff.init({ liffId: '1633210473-BZ1zNNWk' }).then(() => {
        var accessToken = liff.getAccessToken();
        $('#userProfileBox').append(`<div>accessToken: ${accessToken}<br><br></div>`);
        getUserProfile(accessToken);
      }).catch((error) => {
        alert('liff init error: ' + JSON.stringify(error));
      });
    }
  }


  // event 切換是否同意授權
  $('.check-agree').change(() => {
    if ($('.check-agree:checked').length > 0) {
      if (isLogded) {
        $('#logged').find('input[type=text]').change();
      } else {
        $('#notLogin').find('input[type=text], input[type=tel]').change();
      }
    } else {
      $('#notLogin-send-btn, #logged-send-btn').attr('disabled', true);
    }
  });

  // event 未登入的表單欄位檢查是有值用
  $('#notLogin').find('input[require]').change((event) => {
    var isFull = true;
    $.each($('#notLogin').find('input[require]'), function(i, item) {
      if (!$(item).val()) {
        isFull = false;
      }
    });
    // 已填寫並且也同意授權
    if (isFull && $('.check-agree:checked').length > 0) {
      $('#notLogin-send-btn').removeAttr('disabled');
    } else {
      $('#notLogin-send-btn').attr('disabled', true);
    }
  });

  // event 已登入的表單欄位檢查是有值用
  $('#logged').find('input[require]').change((event) => {
    var isFull = true;
    $.each($('#logged').find('input[require]'), function(i, item) {
      if (!$(item).val()) {
        isFull = false;
      }
    });
    // 已填寫並且也同意授權
    if (isFull && $('.check-agree:checked').length > 0) {
      $('#logged-send-btn').removeAttr('disabled');
    } else {
      $('#logged-send-btn').attr('disabled', true);
    }
  });


  // event click 未登入的送出按鈕
  $('#notLogin-send-btn').click(() => {
    console.log('未登入的送出按鈕');
    //TODO... 呼叫api
    $('.dialog-box.complete').addClass('show');
  });

  // event click 已登入的送出按鈕
  $('#logged-send-btn').click(() => {
    console.log('已登入的送出按鈕');
    //TODO... 呼叫api
    $('.dialog-box.complete').addClass('show');
  });

  // event click 觀看個資授權
  $('.lookAuthorization').click(() => {
    $('.authorization').addClass('show');
  });

  // event click 個資授權 dialog 中的 我瞭解了按鈕
  $('#understanding').click(() => {
    $('.authorization').removeClass('show');
  });

  // event click 關閉完成登記 dialog (已登入未登入共用)
  $('#closeLiff-btn').click(() => {
    liff.closeWindow();
  });


  // TODO... 測試28日足跡查詢用
  var trHTML = '';
  for (var i = 0; i <= 10; i++) {
    trHTML += '<tr>';
    trHTML += '  <td>'+ (i+1) +'</td>';
    trHTML += '  <td>2021/05/17 11:56</td>';
    trHTML += '  <td>XXX大樓</td>';
    trHTML += '  <td>36.3</td>';
    trHTML += '</tr>';
  }
  $('table tbody').append(trHTML);


  // TODO... 開發測試用 event
  $('#testNo').click(() => {
    $('.recording').removeClass('logged');
    $('.recording').addClass('notLogin');
    $('#notLogin-banner-word').addClass('show');
    $('#logged-banner-word').removeClass('show');
    isLogded = false;
  });
  $('#testYes').click(() => {
    $('.recording').removeClass('notLogin');
    $('.recording').addClass('logged');
    $('#notLogin-banner-word').removeClass('show');
    $('#logged-banner-word').addClass('show');
    isLogded = true;
  });


  onload();
});
</script>
</body>
</html>