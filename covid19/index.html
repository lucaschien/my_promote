<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>eyesmedia covid19 - 防疫新生活</title>
<link rel="stylesheet" href="./css/reset.css">
<link rel="stylesheet" href="./css/main.css">
<script type="text/javascript" src="./js/jquery.js"></script>
<!-- <script type="text/javascript" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script> -->
<!-- <script type="text/javascript" src="https://static.line-scdn.net/liff/edge/versions/2.10.0/sdk.js"></script> -->

<script src="https://static.line-scdn.net/liff/edge/versions/2.8.0/sdk.js"></script>
<script src="https://static.line-scdn.net/liff-switch/edge/versions/1.0.1/liff-switch.umd.real.js"></script>

</head>
<body>
  <div class="app">
    <div class="main recording">
      <div class="main-banner">防疫新生活｜實聯制</div>
      <div class="main-content">
        <!-- 已登入介面 -->
        <div id="logged">
          <h3>某某某店家</h3>
          <h4>防疫新生活，輕鬆掃QRcode，一秒完成實聯登記</h4>
          <label class="label-box">
            <h5>時間<span class="require">*</span></h5>
            <span class="display-value">2021/05/17 15:46</span>
          </label>
          <label class="label-box">
            <h5>姓名<span class="require">*</span></h5>
            <span class="display-value">王小明</span>
          </label>
          <label class="label-box">
            <h5>手機號碼<span class="require">*</span></h5>
            <span class="display-value">0915555555</span>
          </label>
          <label class="label-box">
            <h5>備註<span class="require">*</span></h5>
            <input type="text">
          </label>

          <label>
            <input type="checkbox" class="check-agree">我已閱讀並同意提供<a href="javascript:;">個資授權</a>
          </label>

          <button type="button" id="logged-send-btn" disabled>送出</button>

        </div>

        <!-- 未登入介面 -->
        <div id="notLogin">
          <label class="label-box">
            <h5>姓名<span class="require">*</span></h5>
            <input type="text">
          </label>
          <label class="label-box">
            <h5>手機號碼<span class="require">*</span></h5>
            <input type="tel">
          </label>
          <label class="label-box">
            <h5>備註<span class="require">*</span></h5>
            <input type="text">
          </label>

          <label>
            <input type="checkbox" class="check-agree">我已閱讀並同意提供<a href="javascript:;">個資授權</a>
          </label>

          <button type="button" id="notLogin-send-btn" disabled>送出</button>
        </div>

        <br><br><br>
        <button id="testNo">開發測試用: 未登入</button>
        <button id="testYes">開發測試用: 已登入</button>

        <div id="userProfileBox"></div>
  
      </div>
    </div>
  </div>

<script>
$(function() {
  $('#userProfileBox').append(`<div>window.location.href: ${JSON.stringify(window.location.href)}<br><br></div>`);
  var isLogded = false; // 記住是否已登入用
  var userModel = {};   // 記住使用者在資料庫中資料用
  var storeModel = {};  // 記住店家在資料庫中資料用

  // 解析瀏覽器url參數
  function parseURLparm() {
    var vars = {}, hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for (var i = 0; i < hashes.length; i++) {
      hash = hashes[i].split('=');
      if (Array.isArray(hash[0], vars) > -1) {
        vars[hash[0]] = hash[1];
      }
    }
    return vars;
  }

  // 
  function convertUrlFromConcatToReplace(concatenateModeUrl, endpointUrl) {
    if (!concatenateModeUrl || !endpointUrl) {
      throw new TypeError('`concatenateModeUrl` and `endpointUrl` are required');
    }
    const concatenateURL = new URL(concatenateModeUrl);
    const endpointURL = new URL(endpointUrl);
    const {
      pathname: concatenateModeUrlPathname,
      searchParams: concatenateModeUrlSearchParams,
    } = concatenateURL;
    const {
      pathname: endpointUrlPathname,
      searchParams: endpointUrlSearchParams,
    } = endpointURL;
    concatenateURL.pathname = concatenateModeUrlPathname.replace(
      endpointUrlPathname,
      '',
    );
    const concatenateModeUrlSearchParamsEntries = [
      ...concatenateModeUrlSearchParams.entries(),
    ];
    let endpointUrlSearchParamsEntries = [...endpointUrlSearchParams.entries()];
    const newSearchParamsEntries = concatenateModeUrlSearchParamsEntries.reduce(
      (ret, entry) => {
        const index = endpointUrlSearchParamsEntries.findIndex(
          ([key, val]) => key === entry[0] && val === entry[1],
        );
        if (index !== -1) {
          endpointUrlSearchParamsEntries = endpointUrlSearchParamsEntries.filter(
            (_, i) => i !== index,
          );
          return ret;
        }
        return [...ret, entry];
      },
      [],
    );
    [...concatenateModeUrlSearchParams.keys()].forEach((key) => {
      concatenateModeUrlSearchParams.delete(key);
    });
    newSearchParamsEntries.forEach(([k, v]) => {
      concatenateModeUrlSearchParams.append(k, v);
    });
    const url = concatenateURL.toString();
    return url;
  }



  // 取得 liff 使用者基本資料
  function getUserProfile(accessToken) {
    //透過 token 取得使用者資訊
    fetch('https://api.line.me/v2/profile', {
      method: 'GET',
      headers: {
        'content-type': 'application/json',
        'Authorization': `Bearer ${accessToken}`
      },
    }).then(response => {
      return response.json();
    }).then((data) => {
      // TODO... 呼叫取得使用者是否已登入api
      isLogded = false;
      $('.recording').removeClass('logged');
      $('.recording').addClass('notLogin');


      // TODO... 開發測試用
      $('#userProfileBox').append(`<div>https://api.line.me/v2/profile:'${JSON.stringify(data)}'<br><br></div>`);
      $('#userProfileBox').append(
        'userId:' + data.userId + '<br>' +
        'displayName:' + data.displayName + '<br>' +
        'pictureUrl:' + data.pictureUrl + '<br>'
      );

    });
  }
  
  // liff 初始化
  function onload() {
    var urlParm = parseURLparm();
    var urlSearch = window.location.search;
    var storeId = urlParm.storeId;
    var liffId = urlParm.liffId;
    $('#userProfileBox').append(`<div><br>storeId: ${storeId}</div>`);
    $('#userProfileBox').append(`<div>liffId: ${liffId}<br><br></div>`);

    if (liff) {
      // TODO... 由於 app 中 liff 打開之後後面的url參數會被轉碼... 這部分還要研究所以先寫死 1633210473-BZ1zNNWk
      liff.init({ liffId: liffId }).then(() => {
        var accessToken = liff.getAccessToken();
        $('#userProfileBox').append(`<div>accessToken: ${accessToken}<br><br></div>`);
        getUserProfile(accessToken);
      }).catch((error) => {
        alert('liff init error: ' + JSON.stringify(error));
      });
    }
  }


  // event 切換是否同意授權
  $('.check-agree').change(() => {
    if ($('.check-agree:checked').length > 0) {
      if (isLogded) {
        $('#logged').find('input[type=text]').change();
      } else {
        $('#notLogin').find('input[type=text], input[type=tel]').change();
      }
    } else {
      $('#notLogin-send-btn, #logged-send-btn').attr('disabled', true);
    }
  });

  // event 未登入的表單欄位檢查是有值用
  $('#notLogin').find('input[type=text], input[type=tel]').change((event) => {
    var isFull = true;
    $.each($('#notLogin').find('input[type=text], input[type=tel]'), function(i, item) {
      if (!$(item).val()) {
        isFull = false;
      }
    });
    // 已填寫並且也同意授權
    if (isFull && $('.check-agree:checked').length > 0) {
      $('#notLogin-send-btn').removeAttr('disabled');
    } else {
      $('#notLogin-send-btn').attr('disabled', true);
    }
  });

  // event 已登入的表單欄位檢查是有值用
  $('#logged').find('input[type=text]').change((event) => {
    var isFull = true;
    $.each($('#logged').find('input[type=text]'), function(i, item) {
      if (!$(item).val()) {
        isFull = false;
      }
    });
    // 已填寫並且也同意授權
    if (isFull && $('.check-agree:checked').length > 0) {
      $('#logged-send-btn').removeAttr('disabled');
    } else {
      $('#logged-send-btn').attr('disabled', true);
    }
  });


  // event click 未登入的送出按鈕
  $('#notLogin-send-btn').click(() => {
    console.log('未登入的送出按鈕');
  });

  // event click 已登入的送出按鈕
  $('#logged-send-btn').click(() => {
    console.log('已登入的送出按鈕');
  });



  // TODO... 開發測試用 event
  $('#testNo').click(() => {
    $('.recording').removeClass('logged');
    $('.recording').addClass('notLogin');
    isLogded = false;
  });
  $('#testYes').click(() => {
    $('.recording').removeClass('notLogin');
    $('.recording').addClass('logged');
    isLogded = true;
  });


  onload();
});
</script>
</body>
</html>